/* This file tells Jenkins how to test this repo. Everything runs in docker 
 * containers, so in theory any Jenkins server should be able to parse this 
 * file. However in the katxgpu case, the Jenkins server needs access to a GPU. 
 * This means that the docker engine being used needs to have been configured to
 * use the Nvidia Container Runtime and the node the container run on needs a 
 * Nvidia GPU with the Nvidia Driver installed.
 */
 
pipeline {
  agent {
    docker {
      /* This nvidia/cuda:10.1-devel-ubuntu18.04 docker image contains the CUDA 
       * developement environment which is required to compile the kernels used
       * by PyCUDA.
       */
      image 'nvidia/cuda:10.1-devel-ubuntu18.04'

      /* --gpus all: This argument passes the Nvidia driver and devices from the
       * host to the container. It requires the NVIDIA Container Runtime to be 
       * installed on the host.
       * 
       * --network=host: I was having trouble getting the docker container to 
       * connect to the internet. This occured when I was using Jenkins in
       * conjunction with docker in docker (dind). This flag resolved that
       * issue. There are probably more elegant solutions, but I have not had a 
       * chance to look into them.
       *
       * -u root: The container needs to be root when running the "apt-get
       * install" commands. When that is moved to a docker file, this flag can 
       * be removed.
       */
      args '--gpus all --network=host -u root '
    }

  }

  /* This stage should ideally be part of the initial Docker image, as it
   * takes time and downloads multple Gigabytes from the internet. A new 
   * Dockerfile needs to be created that will extend the 
   * nvidia/cuda:10.1-devel-ubuntu18.04 image to include this install.
   */
  stages {
    stage('Configure Environment') {
      steps {
        sh 'apt-get update'
        sh 'apt-get install -y python3.6 python3-pip python-pybind11 python3.6-dev git' //Required for python
        sh 'apt-get install -y autoconf libboost-all-dev libibverbs-dev librdmacm-dev libpcap-dev' //Required for installing SPEAD2. Much of this is installed when using MLNX_OFED, TODO: Clarify
      }
    } 

    /* This stage is kept seperate from the "Install katxgpu package" stage
     * below as the stage one will fail when something external goes wrong while
     * the next stage will fail if we have done something wrong in the katxgpu
     * package. It seems best to split them to make it easier to pinpoint the 
     * source of the problem.
     *
     * NOTE: Numpy is installed first because if it is installed as part of the
     * requirements.txt install, pycuda tries to install a later version of
     * numpy which requires python 3.7 or greater. Pybind11 is also installed
     * like this for a similar reason. It will not install when part of 
     * requirements.txt. This has not been investigated
     *
     * NOTE: Jinja2 and pycparser are used by SPEAD2 for generating some source 
     * files. They are not used in the running program.
     */
    stage('Install required python packages') {
      steps {
        sh 'pip3 install numpy==1.19.5 pycparser jinja2 pybind11'
        sh 'pip3 install -r requirements.txt'
        sh 'pip3 install -r requirements-dev.txt'
      }
    }

    /* This stage ensures that all the python style guidelines checks pass.
     * This will catch if someone has commited to the repo without installing 
     * the required pre-commit hooks.
     */
    stage('Check pre-commit hooks have been applied') {
      steps {
        sh 'pre-commit install'
        sh 'pre-commit run --all-files'
      }
    }

    stage('Install katxgpu package') {
      steps {
        sh 'rm /usr/bin/python && ln -s /usr/bin/python3 /usr/bin/python'//Hack to force python 3 use. Not advisable in most situations.
        sh 'pip3 install -e .'
        sh 'pip3 install -e .' //Have to install twice for some reason or else something does not link properly - not sure what the reason for this is
      }
    }

    /* This stage actually runs pytest. Pytest has a number of flags that are not required but make life easier:
     * 1. -n X: Launches X threads and runs the tests in parallel across multiple threads. This speeds up testing significantly.
     *     NOTE: This can create resource contention over things like GPU RAM. If it starts becoming an issue set X to 1.
     * 2. -v: Increases verbosity
     * 3. --junitxml=reports/result.xml' Writes the results to a file for later examination.
     */
    stage('Run pytest') {
      steps {
        sh 'pytest -n 10 -v --junitxml=reports/result.xml'
      }
    }
    
  }
}

//apt-get update && apt-get install -y git vim && git clone --branch spead2_rx_code https://github.com/ska-sa/katxgpu.git && cd katxgpu && git submodule update --init --recursive && apt-get install -y python3 python3-pip python-pybind11 python3-dev git && apt-get install -y autoconf libboost-all-dev libibverbs-dev librdmacm-dev libpcap-dev rdma-core && pip3 install numpy==1.19.5 jinja2 pycparser pybind11 && pip3 install -r requirements.txt && pip3 install -r requirements-dev.txt && rm /usr/bin/python && ln -s /usr/bin/python3 /usr/bin/python && pip3 install -e . && pip3 install -e .